package com.virtualbookstore.bookstoreapp.Services;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.virtualbookstore.bookstoreapp.Entities.Book;
import com.virtualbookstore.bookstoreapp.Entities.CartItem;
import com.virtualbookstore.bookstoreapp.Entities.Order;
import com.virtualbookstore.bookstoreapp.Entities.OrderItem;
import com.virtualbookstore.bookstoreapp.Entities.User;
import com.virtualbookstore.bookstoreapp.enums.OrderStatus;
import com.virtualbookstore.bookstoreapp.repo.BookRepository;
import com.virtualbookstore.bookstoreapp.repo.CartItemRepository;
import com.virtualbookstore.bookstoreapp.repo.OrderItemRepository;
import com.virtualbookstore.bookstoreapp.repo.OrderRepository;
import com.virtualbookstore.bookstoreapp.repo.UserRepository;

@Service
public class OrderService {
	
	private final OrderRepository orderRepository;
	private final CartItemRepository cartItemRepository;
	private final BookRepository bookRepository;
	private final UserRepository userRepository;
	private final OrderItemRepository orderItemRepository;
	
	public OrderService(OrderRepository orderRepository, CartItemRepository cartItemRepository, BookRepository bookRepository, UserRepository userRepository, OrderItemRepository orderItemRepository) {
		
		this.orderRepository=orderRepository;
		this.cartItemRepository=cartItemRepository;
		this.bookRepository=bookRepository;
		this.userRepository=userRepository;
		this.orderItemRepository=orderItemRepository;
		
	}

	@Transactional
	public Order createOrderFromCart(Long userId) {
		
		User user;
			
		Optional<User> optionalUser = userRepository.findById(userId);
			
		if(optionalUser.isPresent()) {
				
			user=optionalUser.get();
				
		} else {
				
			throw new RuntimeException("User not found");
				
		}
			
		List<CartItem> cartItems=cartItemRepository.findByUserId(userId);
		List<OrderItem> orderItems=new ArrayList<>();
		double orderPrice=0.0;
		
		if(cartItems.isEmpty())
			throw new RuntimeException("Cart is Empty");
		
		for(CartItem cartItem: cartItems) {
			
			Book book = cartItem.getBook();
			int quantity = cartItem.getQuantity();
			int stock=book.getStock();
			double price=book.getPrice();
			
			if(quantity>stock) {
				throw new RuntimeException("Insufficient stock for Book with Id: "+ book.getId());
			}
			
			book.setStock(stock-quantity);
			bookRepository.save(book);
			
			OrderItem orderItem = OrderItem.builder()
				.user(user)
				.book(book)
				.quantity(quantity)
				.priceAtPurchase(price)
				.quantity(quantity)
				.build();
			orderItems.add(orderItem);
			orderPrice+=price;
			
		}
		
		Order order= Order.builder()
						.orderItem(orderItems)
						.status(OrderStatus.Placed)
						.totalPrice(orderPrice)
						.user(user)
						.build();
		
		Order savedOrder = orderRepository.save(order);
		
		for(OrderItem item: orderItems ) {
			
			item.setOrder(savedOrder);
			orderItemRepository.save(item);
			
		}
		
		return savedOrder;
		
	}

	public List<Order> getAllOrders(Long userId) {
		// TODO Auto-generated method stub
		return orderRepository.findByUserId(userId);
		
	}

	public Optional<Order> getOrder(Long orderId) {
		
		return orderRepository.findById(orderId);
		
	}

	@Transactional
	public void cancelOrder(Long orderId) {
		
		Optional<Order> optionalOrder = orderRepository.findById(orderId);
		
		if(optionalOrder.isPresent()) {
			
			Order order = optionalOrder.get();
			order.setStatus(OrderStatus.Cancelled);
			orderRepository.save(order);
			
		} else {
			
			throw new RuntimeException("Order not found");
			
		}
		
	}
	

}
