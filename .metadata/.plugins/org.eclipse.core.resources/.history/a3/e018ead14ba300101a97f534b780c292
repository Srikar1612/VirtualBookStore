package com.virtualbookstore.bookstoreapp.Services;

import java.util.Base64;
import java.util.Date;
import java.util.stream.Collectors;

import javax.crypto.SecretKey;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.stereotype.Component;

import com.virtualbookstore.bookstoreapp.config.SecurityConfig;

import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;

@Component
public class JWTService {

    private final SecurityConfig securityConfig;
	private final String SecretK="Secret_Key";
	private final SecretKey secretKey=getKey();

    JWTService(SecurityConfig securityConfig) {
        this.securityConfig = securityConfig;
    }
	
	private SecretKey getKey() {
		
		byte[] byteKey = Base64.getDecoder().decode(SecretK);
		return Keys.hmacShaKeyFor(byteKey);
		
	}
	
	public String generateToken(Authentication authentication) {
		
		return Jwts
				.builder()
				.subject(authentication.getName())
				.claim("roles", authentication.getAuthorities().stream().map(GrantedAuthority::getAuthority).collect(Collectors.joining(",")))
				.issuedAt(new Date(System.currentTimeMillis()))
				.expiration(new Date(System.currentTimeMillis() + 1000*60*60*10))
				.signWith(secretKey)
				.compact();
		
	}
	
	public String getUserNameFromJwt(String token) {
		
		return Jwts
				.parser()
				.verifyWith(secretKey)
				.build()
				.parseSignedClaims(token)
				.getPayload()
				.getSubject();
		
	}
	
}
