	package com.virtualbookstore.bookstoreapp.Services;
	
	import java.util.Base64;
import java.util.Date;
import java.util.stream.Collectors;

import javax.crypto.SecretKey;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.stereotype.Component;

import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import jakarta.annotation.PostConstruct;
	
	@Component
	public class JWTService {
	
		@Value("${jwt.secret}")
		private String SecretK;
		private SecretKey secretKey;
		byte[] byteKey;
		
		@PostConstruct
		public void init() {
			
			try {
			
				if(SecretK==null || SecretK.isEmpty()) {
					
					throw new IllegalStateException("JWT secret key must be configured in application.properties (jwt.secret).");
					
				}
				
				byteKey = Base64.getDecoder().decode(SecretK);
				
				if (byteKey.length < 32) {
					
	                throw new IllegalArgumentException("JWT secret key is too short. Must be at least 32 bytes after Base64 decoding.");
	           
				}
				
				
				this.secretKey=Keys.hmacShaKeyFor(byteKey);
				
			} catch (IllegalArgumentException e) {
				
				 System.err.println("JWT Secret Key decoding error: " + e.getMessage());
		         throw new IllegalStateException("JWT Secret Key configuration error: Invalid Base64 format or too short.", e);
		        
			}
			
		}
		
//		private SecretKey getKey() {
//			
//			byteKey = Base64.getDecoder().decode(SecretK);
//			return Keys.hmacShaKeyFor(byteKey);
//			
//		}
		
		public String generateToken(Authentication authentication) {
			
			return Jwts
					.builder()
					.subject(authentication.getName())
					.claim("roles", authentication.getAuthorities().stream().map(GrantedAuthority::getAuthority).collect(Collectors.joining(",")))
					.issuedAt(new Date(System.currentTimeMillis()))
					.expiration(new Date(System.currentTimeMillis() + 1000*60*60*10))
					.signWith(secretKey)
					.compact();
			
		}
		
		public String getUserNameFromJwt(String token) {
			
			return Jwts
					.parser()
					.verifyWith(secretKey)
					.build()
					.parseSignedClaims(token)
					.getPayload()
					.getSubject();
			
		}
		
		public boolean validateToken(String token) {
			
			try {
				
				Jwts
					.parser()
					.verifyWith(secretKey)
					.build()
					.parseSignedClaims(token);
				return true;
				
			} catch (Exception e) {
				
				System.err.print("Jwt validation error: "+ e.getMessage());
				return false;
				
			}
			
		}
		
	}
