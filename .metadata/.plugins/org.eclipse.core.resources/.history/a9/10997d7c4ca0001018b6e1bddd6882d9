package com.virtualbookstore.bookstoreapp.Services;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.stereotype.Service;

import com.virtualbookstore.bookstoreapp.Entities.Book;
import com.virtualbookstore.bookstoreapp.Entities.CartItem;
import com.virtualbookstore.bookstoreapp.Entities.Order;
import com.virtualbookstore.bookstoreapp.Entities.OrderItem;
import com.virtualbookstore.bookstoreapp.Entities.User;
import com.virtualbookstore.bookstoreapp.repo.BookRepository;
import com.virtualbookstore.bookstoreapp.repo.CartItemRepository;
import com.virtualbookstore.bookstoreapp.repo.OrderRepository;
import com.virtualbookstore.bookstoreapp.repo.UserRepository;

@Service
public class OrderService {
	
	private final OrderRepository orderRepository;
	private final CartItemRepository cartItemRepository;
	private final BookRepository bookRepository;
	private final UserRepository userRepository;
	
	public OrderService(OrderRepository orderRepository, CartItemRepository cartItemRepository, BookRepository bookRepository, UserRepository userRepository) {
		
		this.orderRepository=orderRepository;
		this.cartItemRepository=cartItemRepository;
		this.bookRepository=bookRepository;
		this.userRepository=userRepository;
		
	}

	public Order createOrderFromCart(Long userId) {
		
		User user;
			
		Optional<User> optionalUser = userRepository.findById(userId);
			
		if(optionalUser.isPresent()) {
				
			user=optionalUser.get();
				
		} else {
				
			throw new RuntimeException("User not found");
				
		}
			
		List<CartItem> cartItems=cartItemRepository.findByUserId(userId);
		List<OrderItem> orderItems=new ArrayList<>();
		double orderPrice=0.0;
		
		if(cartItems.isEmpty())
			throw new RuntimeException("Cart is Empty");
		
		for(CartItem cartItem: cartItems) {
			
			Book book = cartItem.getBook();
			int quantity = cartItem.getQuantity();
			int stock=book.getStock();
			
			if(quantity>stock) {
				throw new RuntimeException("Insufficient stock for Book with Id: "+ book.getId());
			}
			
			book.setStock(stock-quantity);
			bookRepository.save(book);
			
			OrderItem.builder()
				.book(book);
				.user
			
		}
		
	}

}
